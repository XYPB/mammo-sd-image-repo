<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pairing Test — Image Consistency Study</title>
<style>
  :root {
    --primary: #2563eb;
    --primary-hover: #1d4ed8;
    --green: #16a34a;
    --green-hover: #15803d;
    --red: #dc2626;
    --red-hover: #b91c1c;
    --bg: #f8fafc;
    --card: #ffffff;
    --border: #e2e8f0;
    --text: #1e293b;
    --muted: #64748b;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: row;
    justify-content: center;
  }

  .container {
    max-width: 1100px;
    width: 100%;
    padding: 2rem 1.5rem 6rem;
  }

  h1 {
    font-size: 1.5rem;
    font-weight: 700;
    text-align: center;
    margin-bottom: 0.25rem;
  }

  .subtitle {
    text-align: center;
    color: var(--muted);
    font-size: 0.95rem;
    margin-bottom: 2rem;
  }

  /* ---------- Intro screen ---------- */
  #intro {
    text-align: center;
    margin-top: 3rem;
  }
  #intro p {
    max-width: 620px;
    margin: 0 auto 1.5rem;
    line-height: 1.65;
    color: var(--text);
    font-size: 1.05rem;
  }

  /* ---------- Quiz ---------- */
  #quiz { display: none; }

  .question-counter {
    text-align: center;
    font-size: 0.9rem;
    color: var(--muted);
    margin-bottom: 1rem;
  }

  .pair-wrapper {
    display: flex;
    gap: 1rem;
    justify-content: center;
    align-items: stretch;
    margin-bottom: 1.25rem;
  }

  .image-panel {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .view-label {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--muted);
    margin-bottom: 0.4rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  .image-box {
    background: #000;
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    width: 512px;
    height: 512px;
    cursor: zoom-in;
  }
  .image-box img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }

  .btn-row {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-bottom: 1rem;
  }

  .btn {
    padding: 0.65rem 2rem;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s, transform 0.1s;
    color: #fff;
    min-width: 160px;
    text-align: center;
  }
  .btn:active { transform: scale(0.97); }

  .btn-yes { background: var(--green); }
  .btn-yes:hover { background: var(--green-hover); }
  .btn-yes.selected { box-shadow: 0 0 0 3px rgba(22,163,74,0.45); }
  .btn-yes.dimmed { background: #94a3b8; }

  .btn-no { background: var(--red); }
  .btn-no:hover { background: var(--red-hover); }
  .btn-no.selected { box-shadow: 0 0 0 3px rgba(220,38,38,0.45); }
  .btn-no.dimmed { background: #94a3b8; }

  .prompt-text {
    text-align: center;
    font-size: 0.95rem;
    color: var(--text);
    margin-bottom: 0.75rem;
  }

  .nav-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .btn-nav {
    padding: 0.5rem 1.5rem;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--card);
    font-size: 0.95rem;
    cursor: pointer;
    color: var(--text);
    transition: background 0.15s;
  }
  .btn-nav:hover { background: #f1f5f9; }
  .btn-nav:disabled { opacity: 0.35; cursor: default; }

  .btn-finish {
    padding: 0.5rem 1.5rem;
    border: none;
    border-radius: 6px;
    background: var(--primary);
    color: #fff;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s;
  }
  .btn-finish:hover { background: var(--primary-hover); }
  .btn-finish:disabled { opacity: 0.35; cursor: default; }

  .btn-start {
    padding: 0.75rem 2.5rem;
    border: none;
    border-radius: 6px;
    background: var(--primary);
    color: #fff;
    font-size: 1.05rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s;
  }
  .btn-start:hover { background: var(--primary-hover); }

  /* ---------- Progress bar ---------- */
  .progress-container {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: var(--card);
    border-top: 1px solid var(--border);
    padding: 0.75rem 1.5rem;
    display: none;
    z-index: 100;
  }
  .progress-label {
    font-size: 0.8rem;
    color: var(--muted);
    margin-bottom: 0.35rem;
    text-align: center;
  }
  .progress-track {
    width: 100%;
    max-width: 600px;
    height: 8px;
    background: #e2e8f0;
    border-radius: 99px;
    margin: 0 auto;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: var(--primary);
    border-radius: 99px;
    transition: width 0.3s ease;
    width: 0%;
  }

  /* ---------- Results ---------- */
  #results { display: none; }

  .results-title {
    text-align: center;
    font-size: 1.35rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }
  .results-subtitle {
    text-align: center;
    color: var(--muted);
    margin-bottom: 2rem;
    font-size: 0.95rem;
  }

  .result-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.25rem 1.5rem;
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .result-card .label {
    font-weight: 600;
    font-size: 1.05rem;
  }
  .result-card .count {
    font-size: 0.85rem;
    color: var(--muted);
  }
  .result-card .pct {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
  }

  .bar-bg {
    height: 6px;
    background: #e2e8f0;
    border-radius: 99px;
    margin-top: 0.5rem;
    overflow: hidden;
  }
  .bar-fg {
    height: 100%;
    background: var(--primary);
    border-radius: 99px;
    transition: width 0.6s ease;
  }

  /* ---------- Confirm overlay ---------- */
  .overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 200;
  }
  .overlay.active { display: flex; }
  .overlay-box {
    background: var(--card);
    border-radius: 10px;
    padding: 2rem 2.5rem;
    text-align: center;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
  }
  .overlay-box p { margin-bottom: 1.25rem; line-height: 1.5; }
  .overlay-btns { display: flex; gap: 0.75rem; justify-content: center; }
  .overlay-btns .btn-nav { min-width: 100px; }

  .restart-row { text-align: center; margin-top: 2rem; }

  /* ---------- Sidebar ---------- */
  .sidebar {
    width: 180px;
    flex-shrink: 0;
    position: sticky;
    top: 0;
    align-self: flex-start;
    height: 100vh;
    display: none;
    flex-direction: column;
    background: var(--card);
    border-right: 1px solid var(--border);
  }
  .sidebar-header {
    padding: 1rem 0.75rem 0.5rem;
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.04em;
    border-bottom: 1px solid var(--border);
  }
  .sidebar-list {
    flex: 1;
    overflow-y: auto;
    padding: 0.5rem 0;
  }
  .sidebar-item {
    padding: 0.35rem 0.75rem;
    font-size: 0.82rem;
    color: var(--text);
    cursor: pointer;
    transition: background 0.1s;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .sidebar-item:hover { background: #f1f5f9; }
  .sidebar-item.active { background: #e0e7ff; color: var(--primary); font-weight: 600; }

  /* ---------- Lightbox ---------- */
  .lightbox {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 300;
    cursor: zoom-out;
  }
  .lightbox.active { display: flex; }
  .lightbox img {
    max-width: 90vw;
    max-height: 90vh;
    object-fit: contain;
    border-radius: 6px;
    box-shadow: 0 0 40px rgba(0,0,0,0.5);
  }
</style>
</head>
<body>

<div class="sidebar" id="sidebar">
  <div class="sidebar-header" id="sidebarHeader">Remaining</div>
  <div class="sidebar-list" id="sidebarList"></div>
</div>
<div class="container">
  <h1>Pairing Test</h1>
  <p class="subtitle">Mammogram Image Consistency Study</p>

  <!-- Intro -->
  <div id="intro">
    <p>
      You will be shown <strong id="totalCountIntro">0</strong> pairs of mammogram images side by side.
      Each pair shows two different views (e.g., CC &amp; MLO or vice versa).
    </p>
    <p>
      For each pair, decide whether the two images look like they come from
      <strong>the same breast of the same patient</strong>. 
      You may consider whether the anatomical structures,, breast shape, and tissue distribution are matched or not.
    </p>
    <p>
      We removed all the text labels and identifying information from the images to ensure a fair evaluation based solely on mammogram visual cues.
    </p>
    <p>
      The images may take a few moments to load, so please be patient. Click on the image to view a larger version if needed.
      You can navigate back and change your answers at any time.
      Results will only be revealed after you have answered every question and confirmed your submission.
    </p>
    <button class="btn-start" onclick="startQuiz()">Begin</button>
  </div>

  <!-- Quiz -->
  <div id="quiz">
    <div class="question-counter" id="counter">Pair 1 / 60</div>
    <div class="pair-wrapper">
      <div class="image-panel">
        <div class="view-label" id="labelA">View A</div>
        <div class="image-box" onclick="openLightbox(0)">
          <img id="imgA" src="" alt="View A">
        </div>
      </div>
      <div class="image-panel">
        <div class="view-label" id="labelB">View B</div>
        <div class="image-box" onclick="openLightbox(1)">
          <img id="imgB" src="" alt="View B">
        </div>
      </div>
    </div>
    <p class="prompt-text">Do these two images come from the same breast of the same patient?</p>
    <div class="btn-row">
      <button class="btn btn-yes" id="btnYes" onclick="answer('yes')">Yes</button>
      <button class="btn btn-no" id="btnNo" onclick="answer('no')">No</button>
    </div>
    <div class="nav-row">
      <button class="btn-nav" id="btnPrev" onclick="navigate(-1)">&larr; Previous</button>
      <button class="btn-finish" id="btnFinish" onclick="tryFinish()" disabled>Finish</button>
      <button class="btn-nav" id="btnNext" onclick="navigate(1)">Next &rarr;</button>
    </div>
  </div>

  <!-- Results -->
  <div id="results">
    <div class="results-title">Results</div>
    <p class="results-subtitle">Percentage of pairs classified as <em>Same Patient</em> by the user</p>
    <div id="resultCards"></div>
    <div class="restart-row">
      <button class="btn-start" onclick="location.reload()">Restart</button>
    </div>
  </div>
</div>

<!-- Progress bar -->
<div class="progress-container" id="progressBar">
  <div class="progress-label" id="progressLabel">0 / 0 answered</div>
  <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <img id="lightboxImg" src="" alt="Zoomed mammogram">
</div>

<!-- Confirm overlay -->
<div class="overlay" id="confirmOverlay">
  <div class="overlay-box">
    <p><strong>Submit your answers?</strong><br>You will not be able to change them after confirmation.</p>
    <div class="overlay-btns">
      <button class="btn-nav" onclick="closeOverlay()">Go back</button>
      <button class="btn-finish" onclick="showResults()">Confirm</button>
    </div>
  </div>
</div>

<script>
// ========== Configuration ==========
const N = 20; // Number of pairs to show per folder (set to Infinity to show all)
const GITHUB_BASE = "https://raw.githubusercontent.com/XYPB/mammo-sd-image-repo/master/";

// ========== Image data ==========
const folders = {
  "csaw_orig": [
    "00180_20990909_R_CC_1_resized.png",
    "00180_20990909_R_MLO_1_resized.png",
    "00252_20990909_L_CC_1_resized.png",
    "00252_20990909_L_MLO_1_resized.png",
    "00252_20990909_R_CC_3_resized.png",
    "00252_20990909_R_MLO_3_resized.png",
    "00815_20990909_L_CC_3_resized.png",
    "00815_20990909_L_MLO_3_resized.png",
    "00875_20990909_R_CC_1_resized.png",
    "00875_20990909_R_MLO_1_resized.png",
    "00941_20990909_R_CC_2_resized.png",
    "00941_20990909_R_MLO_2_resized.png",
    "01032_20990909_L_CC_1_resized.png",
    "01032_20990909_L_MLO_1_resized.png",
    "01304_20990909_R_CC_2_resized.png",
    "01304_20990909_R_MLO_2_resized.png",
    "02217_20990909_R_CC_3_resized.png",
    "02217_20990909_R_MLO_3_resized.png",
    "02429_20990909_R_CC_3_resized.png",
    "02429_20990909_R_MLO_3_resized.png",
    "02694_20990909_L_CC_5_resized.png",
    "02694_20990909_L_MLO_5_resized.png",
    "04252_20990909_R_CC_2_resized.png",
    "04252_20990909_R_MLO_2_resized.png",
    "05331_20990909_L_CC_4_resized.png",
    "05331_20990909_L_MLO_4_resized.png",
    "05902_20990909_R_CC_1_resized.png",
    "05902_20990909_R_MLO_1_resized.png",
    "06423_20990909_R_CC_4_resized.png",
    "06423_20990909_R_MLO_4_resized.png",
    "06906_20990909_L_CC_3_resized.png",
    "06906_20990909_L_MLO_3_resized.png",
    "07500_20990909_L_CC_1_resized.png",
    "07500_20990909_L_MLO_1_resized.png",
    "07540_20990909_L_CC_4_resized.png",
    "07540_20990909_L_MLO_4_resized.png",
    "07540_20990909_R_CC_3_resized.png",
    "07540_20990909_R_MLO_3_resized.png",
    "09295_20990909_L_CC_3_resized.png",
    "09295_20990909_L_MLO_3_resized.png"
  ],
  "mammo-rgb": [
    "img_105_view1_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_602_view1_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_105_view2_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_602_view2_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_124_view1_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_617_view1_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_124_view2_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_617_view2_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_141_view1_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_643_view1_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_141_view2_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_643_view2_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_193_view1_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_655_view1_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_193_view2_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_655_view2_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_24_view1_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_69_view1_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_24_view2_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_69_view2_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_300_view1_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_70_view1_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_300_view2_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_70_view2_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_302_view1_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_760_view1_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_302_view2_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_760_view2_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_367_view1_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_7_view1_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_367_view2_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_7_view2_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_436_view1_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_846_view1_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_436_view2_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_846_view2_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_487_view1_Two_left_side_breast_mammograms_with_malignant_can.jpg",
    "img_901_view1_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_487_view2_Two_left_side_breast_mammograms_with_malignant_can.jpg",
    "img_901_view2_Two_healthy_right_breast_mammograms,_the_first_ima.jpg"
  ],
  "ca3d": [
    "00668_R_CC.png",
    "00668_R_MLO.png",
    "00888_L_CC.png",
    "00888_L_MLO.png",
    "00909_L_CC.png",
    "00909_L_MLO.png",
    "02761_R_CC.png",
    "02761_R_MLO.png",
    "03046_R_CC.png",
    "03046_R_MLO.png",
    "03259_R_CC.png",
    "03259_R_MLO.png",
    "03499_R_CC.png",
    "03499_R_MLO.png",
    "04540_R_CC.png",
    "04540_R_MLO.png",
    "06080_R_CC.png",
    "06080_R_MLO.png",
    "06508_R_CC.png",
    "06508_R_MLO.png",
    "06854_R_CC.png",
    "06854_R_MLO.png",
    "08809_R_CC.png",
    "08809_R_MLO.png",
    "09651_L_CC.png",
    "09651_L_MLO.png",
    "09837_L_CC.png",
    "09837_L_MLO.png",
    "09999_L_CC.png",
    "09999_L_MLO.png",
    "10170_L_CC.png",
    "10170_L_MLO.png",
    "10452_L_CC.png",
    "10452_L_MLO.png",
    "10458_R_CC.png",
    "10458_R_MLO.png",
    "10463_L_CC.png",
    "10463_L_MLO.png",
    "11081_R_CC.png",
    "11081_R_MLO.png"
  ],
  "ours": [
    "img_18_view1_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_18_view2_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_243_view1_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_243_view2_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_247_view1_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_247_view2_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_299_view1_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_299_view2_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_356_view1_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_356_view2_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_370_view1_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_370_view2_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_40_view1_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_40_view2_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_450_view1_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_450_view2_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_48_view1_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_48_view2_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_523_view1_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_523_view2_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_595_view1_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_595_view2_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_609_view1_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_609_view2_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_657_view1_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_657_view2_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_743_view1_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_743_view2_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_773_view1_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_773_view2_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_803_view1_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_803_view2_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_844_view1_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_844_view2_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_865_view1_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_865_view2_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_950_view1_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_950_view2_Two_healthy_left_breast_mammograms,_the_first_imag.jpg",
    "img_998_view1_Two_healthy_right_breast_mammograms,_the_first_ima.jpg",
    "img_998_view2_Two_healthy_right_breast_mammograms,_the_first_ima.jpg"
  ]
};

// ========== Pairing logic ==========
// csaw_orig: pair by replacing _CC_ / _MLO_ with a common key
// mammo-rgb & ours: pair by replacing _view1_ / _view2_ with a common key
function pairKey(folder, filename) {
  if (folder === "csaw_orig") {
    return filename.replace(/_CC_/, '_VIEW_').replace(/_MLO_/, '_VIEW_');
  }
  if (folder === "ca3d") {
    return filename.replace(/_CC\./, '_VIEW.').replace(/_MLO\./, '_VIEW.');
  }
  return filename.replace(/_view1_/, '_VIEW_').replace(/_view2_/, '_VIEW_');
}

function viewLabel(folder, filename, index) {
  return index === 0 ? 'View 1' : 'View 2';
}

// Fisher-Yates shuffle
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

// ========== Build pairs & shuffle ==========
let pairs = [];
for (const [folder, files] of Object.entries(folders)) {
  const groups = {};
  for (const file of files) {
    const key = pairKey(folder, file);
    if (!groups[key]) groups[key] = [];
    groups[key].push(file);
  }

  let folderPairs = [];
  for (const [key, group] of Object.entries(groups)) {
    if (group.length === 2) {
      // Sort so first view comes first (CC before MLO, view1 before view2)
      group.sort();
      folderPairs.push({
        folder,
        fileA: group[0],
        fileB: group[1],
        pathA: GITHUB_BASE + encodeURI(folder + "/" + group[0]),
        pathB: GITHUB_BASE + encodeURI(folder + "/" + group[1]),
        labelA: viewLabel(folder, group[0], 0),
        labelB: viewLabel(folder, group[1], 1),
        answer: null
      });
    }
  }

  // Randomly sample N pairs from this folder
  shuffle(folderPairs);
  pairs.push(...folderPairs.slice(0, Math.min(N, folderPairs.length)));
}
shuffle(pairs);

const total = pairs.length;
let idx = 0;

document.getElementById("totalCountIntro").textContent = total;

// ========== Quiz logic ==========
function startQuiz() {
  document.getElementById("intro").style.display = "none";
  document.getElementById("quiz").style.display = "block";
  document.getElementById("progressBar").style.display = "block";
  document.getElementById("sidebar").style.display = "flex";
  render();
}

function render() {
  const pair = pairs[idx];
  document.getElementById("counter").textContent = `Pair ${idx + 1} / ${total}`;
  document.getElementById("imgA").src = pair.pathA;
  document.getElementById("imgB").src = pair.pathB;
  document.getElementById("labelA").textContent = pair.labelA;
  document.getElementById("labelB").textContent = pair.labelB;

  // Highlight selected button, dim the other
  const btnYes = document.getElementById("btnYes");
  const btnNo = document.getElementById("btnNo");
  btnYes.classList.toggle("selected", pair.answer === "yes");
  btnYes.classList.toggle("dimmed", pair.answer === "no");
  btnNo.classList.toggle("selected", pair.answer === "no");
  btnNo.classList.toggle("dimmed", pair.answer === "yes");

  // Navigation
  document.getElementById("btnPrev").disabled = idx === 0;
  document.getElementById("btnNext").disabled = idx === total - 1;

  // Finish button
  const answeredCount = pairs.filter(p => p.answer !== null).length;
  document.getElementById("btnFinish").disabled = answeredCount < total;

  // Progress
  document.getElementById("progressLabel").textContent = `${answeredCount} / ${total} answered`;
  document.getElementById("progressFill").style.width = `${(answeredCount / total) * 100}%`;

  // Sidebar — show only unanswered questions
  const list = document.getElementById("sidebarList");
  list.innerHTML = "";
  const unanswered = pairs.map((p, i) => ({ i, p })).filter(o => o.p.answer === null);
  document.getElementById("sidebarHeader").textContent = `Remaining (${unanswered.length})`;
  for (const { i } of unanswered) {
    const el = document.createElement("div");
    el.className = "sidebar-item" + (i === idx ? " active" : "");
    el.textContent = `Pair #${i + 1}`;
    el.onclick = () => { idx = i; render(); };
    list.appendChild(el);
  }
}

function answer(choice) {
  pairs[idx].answer = choice;
  render();
  if (idx < total - 1) {
    setTimeout(() => { idx++; render(); }, 250);
  }
}

function navigate(dir) {
  idx = Math.max(0, Math.min(total - 1, idx + dir));
  render();
}

function tryFinish() {
  document.getElementById("confirmOverlay").classList.add("active");
}

function closeOverlay() {
  document.getElementById("confirmOverlay").classList.remove("active");
}

function openLightbox(which) {
  const pair = pairs[idx];
  const src = which === 0 ? pair.pathA : pair.pathB;
  document.getElementById("lightboxImg").src = src;
  document.getElementById("lightbox").classList.add("active");
}

function closeLightbox() {
  document.getElementById("lightbox").classList.remove("active");
}

// ========== Results ==========
const folderLabels = {
  "csaw_orig": "CSAW (Original)",
  "mammo-rgb": "Mammo-RGB",
  "ca3d": "CA3D",
  "ours": "Mammo-Align"
};

function showResults() {
  closeOverlay();
  document.getElementById("quiz").style.display = "none";
  document.getElementById("progressBar").style.display = "none";
  document.getElementById("sidebar").style.display = "none";
  document.getElementById("results").style.display = "block";

  const stats = {};
  for (const key of Object.keys(folders)) {
    stats[key] = { total: 0, yes: 0 };
  }
  for (const pair of pairs) {
    stats[pair.folder].total++;
    if (pair.answer === "yes") stats[pair.folder].yes++;
  }

  const container = document.getElementById("resultCards");
  container.innerHTML = "";

  for (const key of Object.keys(folders)) {
    const s = stats[key];
    const pct = s.total > 0 ? ((s.yes / s.total) * 100).toFixed(1) : 0;
    const card = document.createElement("div");
    card.className = "result-card";
    card.innerHTML = `
      <div style="flex:1">
        <div class="label">${folderLabels[key] || key}</div>
        <div class="count">${s.yes} of ${s.total} pairs classified as Same Patient</div>
        <div class="bar-bg"><div class="bar-fg" style="width:0%"></div></div>
      </div>
      <div class="pct" style="margin-left:1.5rem">${pct}%</div>
    `;
    container.appendChild(card);
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        card.querySelector(".bar-fg").style.width = pct + "%";
      });
    });
  }
}

// Keyboard shortcuts
document.addEventListener("keydown", e => {
  if (document.getElementById("quiz").style.display === "none") return;
  if (document.getElementById("lightbox").classList.contains("active")) {
    if (e.key === "Escape") closeLightbox();
    return;
  }
  if (document.getElementById("confirmOverlay").classList.contains("active")) {
    if (e.key === "Escape") closeOverlay();
    if (e.key === "Enter") showResults();
    return;
  }
  if (e.key === "ArrowLeft") navigate(-1);
  if (e.key === "ArrowRight") navigate(1);
  if (e.key === "1" || e.key === "y") answer("yes");
  if (e.key === "2" || e.key === "n") answer("no");
});
</script>

</body>
</html>
